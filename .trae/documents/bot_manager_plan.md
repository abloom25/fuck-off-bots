# 机器人互怼管理插件开发计划

## 1. 项目概况
本项目旨在使用 NoneBot2 和 OneBot V11 协议（配合 NapCat）开发一个 QQ 机器人，用于管理群内的其他第三方机器人。主要功能是防止这些机器人互相 @ 导致死循环对话。

## 2. 环境准备与项目初始化
- [ ] **检查环境**: 确认 Python 版本 >= 3.9（已满足）。
- [ ] **完善项目结构**:
    - 创建入口文件 `bot.py`。
    - 创建插件目录 `src/plugins/bot_manager`。
    - 创建插件入口 `src/plugins/bot_manager/__init__.py`。
    - 创建配置文件 `.env`（根据 NapCat 配置调整端口）。

## 3. 核心功能开发 (Bot Manager 插件)
我们将开发一个名为 `bot_manager` 的插件，包含以下功能：

### 3.1 机器人列表管理
我们需要维护一个“受监控机器人列表”，只有在这个列表中的机器人互相 @ 才会触发禁言逻辑。
- [ ] **数据存储**: 使用 JSON 文件 `bots.json` 持久化存储受监控的机器人 QQ 号列表。
- [ ] **指令开发**:
    - `/add_bot <qq>`: 添加机器人到监控列表（仅超级用户可用）。
    - `/del_bot <qq>`: 从监控列表移除机器人（仅超级用户可用）。
    - `/list_bots`: 查看当前监控列表（仅超级用户可用）。

### 3.2 互怼检测与禁言逻辑
- [ ] **监听消息**: 监听群消息事件 (`GroupMessageEvent`)。
- [ ] **检测逻辑**:
    1. **发送者检查**: 判断消息发送者是否在 `bots.json` 列表中。
    2. **@对象检查**: 判断消息是否 @ 了 `bots.json` 列表中的其他机器人。
    3. **频率检测**:
        - 维护一个滑动窗口记录（如最近 60 秒内的交互）。
        - 记录格式：`(sender_id, target_id, timestamp)`。
        - 如果在短时间内（如 30 秒）检测到超过阈值（如 3 次）的互 @ 行为，判定为死循环。
- [ ] **执行惩罚**:
    - 调用 `set_group_ban` 接口，将触发阈值的机器人禁言指定时长（如 10 分钟）。
    - 发送提示消息：“检测到机器人互怼，已禁言 [QQ号] 10分钟。”

## 4. 配置与运行
- [ ] **NapCat 连接配置**: 在 `.env` 中配置 WebSocket 连接地址（通常为 `ws://127.0.0.1:3001` 或类似，需根据用户实际 NapCat 配置调整）。
- [ ] **启动测试**: 使用 `nb run` 或 `python bot.py` 启动机器人。

## 5. 验证计划
- [ ] **模拟测试**: 由于无法直接运行真实 QQ，我们将通过日志输出验证逻辑。
- [ ] **代码审查**: 检查代码逻辑是否严谨，特别是并发和状态管理。

## 6. 下一步
- 用户确认计划后，开始编写代码。
